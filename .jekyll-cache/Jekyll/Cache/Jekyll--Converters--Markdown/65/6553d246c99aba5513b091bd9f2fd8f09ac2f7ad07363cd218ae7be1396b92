I"8Å<h2 id="the-problem">The Problem</h2>

<p>Many years ago a friend and I built whatsthatcharge.com, a site to help people identify mysterious charges on their credit card statement. Visitors could post the text of the charge, and others could weigh in on what it was. In the early years it seemed to be working well; people were helping each other solve those mysteries. But, as time went on we started to see inappropriate content on the site: some comments used strong language, some didn‚Äôt understand the purpose of the site, and spamming and scamming started to appear as well.</p>

<p>We wrote some automatic rules to block profanity or specific spammy links, which helped some. We also added an admin UI for us to manually flag a comment as inappropriate. But as the traffic grew it became untenable to hand-review everything, and our rules either didn‚Äôt catch enough spam or excluded too many valid comments.</p>

<p>We had a vague sense that Machine Learning (ML) could help us with this problem, but it felt like a big lift to invest in the ML knowledge and infra we‚Äôd need to build it all out. Most of the software-as-a-service offerings in the ML space were surprisingly difficult to use for what seemed like a relatively simple use case.</p>

<h2 id="the-solution">The Solution</h2>

<p><a href="https://www.nyckel.com">Nyckel</a> abstracts away most of the heavy lifting to make it easy for developers to build ML into their applications. You‚Äôre basically creating a cloud-hosted function, but instead of writing code to compute the output based on an input, you‚Äôre training the function with example data.</p>

<p>Below are the steps we took to train a content moderation function for whatsthatcharge.</p>

<h2 id="step-1-create-a-function-via-ui">Step 1: Create a Function (via UI)</h2>

<p>After signing in, we created a new Nyckel function that takes text (the comment) as input, and outputs ‚ÄúNot appropriate‚Äù or ‚ÄúAppropriate‚Äù</p>

<h2 id="step-2-import-our-data-via-api">Step 2: Import our Data (via API)</h2>

<p>Although Nyckel has a UI to allow you to upload data, in our case we wanted to submit the data via API so that we can eventually automate the process. In the Nyckel UI there‚Äôs an ‚ÄúAPI‚Äù tab with code snippets we‚Äôll use to upload samples (our comments) and annotations (whether they‚Äôre appropriate):</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># POST a sample</span>
<span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="p">(</span><span class="s2">"https://www.nyckel.com/v0.9/functions/dct6kijvs35x9s08/samples"</span><span class="p">)</span>
<span class="n">request</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">::</span><span class="no">Post</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="s1">'Content-Type'</span> <span class="o">=&gt;</span> <span class="s1">'application/json'</span><span class="p">,</span> <span class="s1">'Authorization'</span> <span class="o">=&gt;</span> <span class="s2">"Bearer </span><span class="si">#{</span><span class="n">access_token</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="n">request</span><span class="p">.</span><span class="nf">body</span> <span class="o">=</span> <span class="p">{</span><span class="ss">input: </span><span class="p">{</span><span class="ss">inlineData: </span><span class="n">sample_data</span><span class="p">}}.</span><span class="nf">to_json</span>
<span class="n">response</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="n">uri</span><span class="p">.</span><span class="nf">hostname</span><span class="p">,</span> <span class="n">uri</span><span class="p">.</span><span class="nf">port</span><span class="p">,</span> <span class="ss">use_ssl: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">http</span><span class="o">|</span>
  <span class="n">http</span><span class="p">.</span><span class="nf">request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="k">end</span>
<span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">)</span>
 
<span class="c1"># POST an Annotation</span>
<span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="p">(</span><span class="s2">"https://www.nyckel.com/v0.9/functions/dct6kijvs35x9s08/annotations"</span><span class="p">)</span>
<span class="n">request</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">::</span><span class="no">Post</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="s1">'Content-Type'</span> <span class="o">=&gt;</span> <span class="s1">'application/json'</span><span class="p">,</span> <span class="s1">'Authorization'</span> <span class="o">=&gt;</span> <span class="s2">"Bearer </span><span class="si">#{</span><span class="n">access_token</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="n">request</span><span class="p">.</span><span class="nf">body</span> <span class="o">=</span> <span class="p">{</span><span class="ss">sampleId: </span><span class="n">sample_id</span><span class="p">,</span> <span class="ss">labelIndex: </span><span class="n">label_index</span><span class="p">}.</span><span class="nf">to_json</span>
<span class="n">response</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="n">uri</span><span class="p">.</span><span class="nf">hostname</span><span class="p">,</span> <span class="n">uri</span><span class="p">.</span><span class="nf">port</span><span class="p">,</span> <span class="ss">use_ssl: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">http</span><span class="o">|</span>
  <span class="n">http</span><span class="p">.</span><span class="nf">request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="k">end</span>
<span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">)</span>
</code></pre></div></div>

<p>Note in addition to needing to supply sample_data (the comment text) and label_index (0 for inappropriate, 1 for appropriate), we also need to provide an access_token. For that, we need a third snippet from the docs:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># POST to get an access token</span>
<span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="p">(</span><span class="s2">"https://www.nyckel.com/connect/token"</span><span class="p">)</span>
<span class="n">request</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">::</span><span class="no">Post</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
<span class="n">request</span><span class="p">.</span><span class="nf">set_form_data</span><span class="p">({</span><span class="s1">'client_id'</span> <span class="o">=&gt;</span> <span class="n">client_id</span><span class="p">,</span> <span class="s1">'client_secret'</span> <span class="o">=&gt;</span> <span class="n">client_secret</span><span class="p">,</span> <span class="s1">'grant_type'</span> <span class="o">=&gt;</span> <span class="s1">'client_credentials'</span><span class="p">})</span>
<span class="n">response</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="n">uri</span><span class="p">.</span><span class="nf">hostname</span><span class="p">,</span> <span class="n">uri</span><span class="p">.</span><span class="nf">port</span><span class="p">,</span> <span class="ss">use_ssl: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">http</span><span class="o">|</span>
  <span class="n">http</span><span class="p">.</span><span class="nf">request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="k">end</span>
<span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">)</span>
</code></pre></div></div>

<p>Taking these snippets, we created a NyckelClient class:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'net/http'</span>
<span class="nb">require</span> <span class="s1">'date'</span>
<span class="nb">require</span> <span class="s1">'json'</span>
 
<span class="k">class</span> <span class="nc">NyckelClient</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">()</span>
    <span class="vi">@client_id</span> <span class="o">||=</span> <span class="no">ENV</span><span class="p">[</span><span class="s1">'NYCKEL_CLIENT_ID'</span><span class="p">]</span>
    <span class="vi">@client_secret</span> <span class="o">||=</span> <span class="no">ENV</span><span class="p">[</span><span class="s1">'NYCKEL_CLIENT_SECRET'</span><span class="p">]</span>
  <span class="k">end</span>
 
  <span class="k">def</span> <span class="nf">create_token</span><span class="p">()</span>
    <span class="c1"># POST to get an access token</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="p">(</span><span class="s2">"https://www.nyckel.com/connect/token"</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">::</span><span class="no">Post</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
    <span class="n">request</span><span class="p">.</span><span class="nf">set_form_data</span><span class="p">({</span><span class="s1">'client_id'</span> <span class="o">=&gt;</span> <span class="n">client_id</span><span class="p">,</span> <span class="s1">'client_secret'</span> <span class="o">=&gt;</span> <span class="n">client_secret</span><span class="p">,</span> <span class="s1">'grant_type'</span> <span class="o">=&gt;</span> <span class="s1">'client_credentials'</span><span class="p">})</span>
    <span class="n">response</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="n">uri</span><span class="p">.</span><span class="nf">hostname</span><span class="p">,</span> <span class="n">uri</span><span class="p">.</span><span class="nf">port</span><span class="p">,</span> <span class="ss">use_ssl: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">http</span><span class="o">|</span>
      <span class="n">http</span><span class="p">.</span><span class="nf">request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">)</span>
  <span class="k">end</span>
 
  <span class="k">def</span> <span class="nf">get_token</span><span class="p">()</span>
    <span class="k">unless</span> <span class="k">defined?</span><span class="p">(</span><span class="vi">@token_expires_at</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="vi">@token_expires_at</span> <span class="o">&gt;</span> <span class="p">(</span><span class="no">DateTime</span><span class="p">.</span><span class="nf">now</span> <span class="o">+</span> <span class="mi">60</span><span class="p">.</span><span class="nf">seconds</span><span class="p">)</span>
      <span class="n">token_response</span> <span class="o">=</span> <span class="n">create_token</span><span class="p">()</span>
      <span class="vi">@access_token</span> <span class="o">=</span> <span class="n">token_response</span><span class="p">[</span><span class="s1">'access_token'</span><span class="p">]</span>
      <span class="vi">@token_expires_at</span> <span class="o">=</span> <span class="no">DateTime</span><span class="p">.</span><span class="nf">now</span> <span class="o">+</span> <span class="n">token_response</span><span class="p">[</span><span class="s1">'expires_in'</span><span class="p">].</span><span class="nf">seconds</span>
    <span class="k">end</span>
    <span class="vi">@access_token</span>
  <span class="k">end</span>
 
  <span class="k">def</span> <span class="nf">create_sample</span><span class="p">(</span><span class="n">sample_data</span><span class="p">)</span>
    <span class="c1"># POST a Sample</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="p">(</span><span class="s2">"https://www.nyckel.com/v0.9/functions/dct6kijvs35x9s08/samples"</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">::</span><span class="no">Post</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="s1">'Content-Type'</span> <span class="o">=&gt;</span> <span class="s1">'application/json'</span><span class="p">,</span> <span class="s1">'Authorization'</span> <span class="o">=&gt;</span> <span class="s2">"Bearer </span><span class="si">#{</span><span class="n">get_token</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">request</span><span class="p">.</span><span class="nf">body</span> <span class="o">=</span> <span class="p">{</span><span class="ss">input: </span><span class="p">{</span><span class="ss">inlineData: </span><span class="n">sample_data</span><span class="p">}}.</span><span class="nf">to_json</span>
    <span class="n">response</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="n">uri</span><span class="p">.</span><span class="nf">hostname</span><span class="p">,</span> <span class="n">uri</span><span class="p">.</span><span class="nf">port</span><span class="p">,</span> <span class="ss">use_ssl: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">http</span><span class="o">|</span>
      <span class="n">http</span><span class="p">.</span><span class="nf">request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">)</span>
  <span class="k">end</span>
 
  <span class="k">def</span> <span class="nf">create_annotation</span><span class="p">(</span><span class="n">sample_id</span><span class="p">,</span> <span class="n">label_index</span><span class="p">)</span>
    <span class="c1"># POST an Annotation</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="p">(</span><span class="s2">"https://www.nyckel.com/v0.9/functions/dct6kijvs35x9s08/annotations"</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">::</span><span class="no">Post</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="s1">'Content-Type'</span> <span class="o">=&gt;</span> <span class="s1">'application/json'</span><span class="p">,</span> <span class="s1">'Authorization'</span> <span class="o">=&gt;</span> <span class="s2">"Bearer </span><span class="si">#{</span><span class="n">get_token</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">request</span><span class="p">.</span><span class="nf">body</span> <span class="o">=</span> <span class="p">{</span><span class="ss">sampleId: </span><span class="n">sample_id</span><span class="p">,</span> <span class="ss">labelIndex: </span><span class="n">label_index</span><span class="p">}.</span><span class="nf">to_json</span>
    <span class="n">response</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="n">uri</span><span class="p">.</span><span class="nf">hostname</span><span class="p">,</span> <span class="n">uri</span><span class="p">.</span><span class="nf">port</span><span class="p">,</span> <span class="ss">use_ssl: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">http</span><span class="o">|</span>
      <span class="n">http</span><span class="p">.</span><span class="nf">request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">)</span>
  <span class="k">end</span>
 
  <span class="k">def</span> <span class="nf">invoke</span><span class="p">(</span><span class="n">sample_data</span><span class="p">)</span>
    <span class="c1"># POST to get a prediction</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="p">(</span><span class="s2">"https://www.nyckel.com/v0.9/functions/dct6kijvs35x9s08/invoke"</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">::</span><span class="no">Post</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="s1">'Content-Type'</span> <span class="o">=&gt;</span> <span class="s1">'application/json'</span><span class="p">,</span> <span class="s1">'Authorization'</span> <span class="o">=&gt;</span> <span class="s2">"Bearer </span><span class="si">#{</span><span class="n">get_token</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">request</span><span class="p">.</span><span class="nf">body</span> <span class="o">=</span> <span class="p">{</span><span class="ss">data: </span><span class="n">sample_data</span><span class="p">}.</span><span class="nf">to_json</span>
    <span class="n">response</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="n">uri</span><span class="p">.</span><span class="nf">hostname</span><span class="p">,</span> <span class="n">uri</span><span class="p">.</span><span class="nf">port</span><span class="p">,</span> <span class="ss">use_ssl: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">http</span><span class="o">|</span>
      <span class="n">http</span><span class="p">.</span><span class="nf">request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Note that we‚Äôre storing the client_id and client_secret in environment variables as suggested by our hosting provider Heroku. Also note the get_token function which ensures that we create a new token any time the existing one gets close to expiring.
Now, using the NyckelClient, we can create a rake task to send our samples and annotations to Nyckel:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">namespace</span> <span class="ss">:ml</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s1">'Submit the annotated comments'</span>
  <span class="n">task</span> <span class="ss">submit_annotated: :environment</span> <span class="k">do</span> <span class="o">|</span><span class="n">task</span><span class="p">,</span> <span class="n">args</span><span class="o">|</span>
    <span class="n">client</span> <span class="o">=</span> <span class="no">NyckelClient</span><span class="p">.</span><span class="nf">new</span>
 
    <span class="n">annotated_comments</span> <span class="o">=</span> <span class="no">Comment</span><span class="p">.</span><span class="nf">where</span><span class="p">.</span><span class="nf">not</span><span class="p">(</span><span class="ss">appropriate: </span><span class="kp">nil</span><span class="p">)</span>
    <span class="n">progressbar</span> <span class="o">=</span> <span class="no">ProgressBar</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">title: </span><span class="s1">'Comments'</span><span class="p">,</span> <span class="ss">total: </span><span class="n">annotated_comments</span><span class="p">.</span><span class="nf">count</span><span class="p">)</span>
 
    <span class="n">annotated_comments</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">comment</span><span class="o">|</span>
      <span class="n">sample</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">create_sample</span><span class="p">(</span><span class="n">comment</span><span class="p">.</span><span class="nf">text</span><span class="p">)</span>
      <span class="n">annotation</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">create_annotation</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s1">'id'</span><span class="p">],</span> <span class="n">comment</span><span class="p">.</span><span class="nf">appropriate</span> <span class="p">?</span> <span class="mi">1</span> <span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
 
      <span class="n">progressbar</span><span class="p">.</span><span class="nf">increment</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>We‚Äôre using the ruby-progressbar gem so we can watch it churn through the comments.</p>

<p>Running the rake task on the command line:</p>

<pre><code class="language-rake">rake ml:submit_annotated
</code></pre>

<p>As the data is being submitted, you can go back to the UI and watch as the data is imported, and every so often Nyckel trains a model that reflects the data submitted so far.</p>

<h2 id="step-3-predict-all-comments">Step 3: Predict All Comments</h2>

<p>Now that we have a model, it‚Äôs time to get Nyckel‚Äôs opinion on which comments are appropriate and which are not. For that we need to add an invoke() method to our NyckelClient class:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">NyckelClient</span>
  <span class="o">...</span>
 
  <span class="k">def</span> <span class="nf">invoke</span><span class="p">(</span><span class="n">sample_data</span><span class="p">)</span>
    <span class="c1"># POST to get a prediction</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="p">(</span><span class="s2">"https://www.nyckel.com/v0.9/functions/dct6kijvs35x9s08/invoke"</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">::</span><span class="no">Post</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="s1">'Content-Type'</span> <span class="o">=&gt;</span> <span class="s1">'application/json'</span><span class="p">,</span> <span class="s1">'Authorization'</span> <span class="o">=&gt;</span> <span class="s2">"Bearer </span><span class="si">#{</span><span class="n">get_token</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">request</span><span class="p">.</span><span class="nf">body</span> <span class="o">=</span> <span class="p">{</span><span class="ss">data: </span><span class="n">sample_data</span><span class="p">}.</span><span class="nf">to_json</span>
    <span class="n">response</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="n">uri</span><span class="p">.</span><span class="nf">hostname</span><span class="p">,</span> <span class="n">uri</span><span class="p">.</span><span class="nf">port</span><span class="p">,</span> <span class="ss">use_ssl: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">http</span><span class="o">|</span>
      <span class="n">http</span><span class="p">.</span><span class="nf">request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>and another rake task:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">namespace</span> <span class="ss">:ml</span> <span class="k">do</span>
  <span class="o">...</span>
 
  <span class="n">desc</span> <span class="s1">'Gets predictions for all comments'</span>
  <span class="n">task</span> <span class="ss">predict_comments: :environment</span> <span class="k">do</span> <span class="o">|</span><span class="n">task</span><span class="p">,</span> <span class="n">args</span><span class="o">|</span>
    <span class="n">client</span> <span class="o">=</span> <span class="no">NyckelClient</span><span class="p">.</span><span class="nf">new</span>
 
    <span class="n">comments</span> <span class="o">=</span> <span class="no">Post</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s1">'predicted_appropriate is null'</span><span class="p">)</span>
    <span class="n">comments_count</span> <span class="o">=</span> <span class="n">comments</span><span class="p">.</span><span class="nf">count</span><span class="p">()</span>
    <span class="nb">puts</span> <span class="s2">"Predicting </span><span class="si">#{</span><span class="n">comments_count</span><span class="si">}</span><span class="s2"> comments"</span>
 
    <span class="n">progressbar</span> <span class="o">=</span> <span class="no">ProgressBar</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">title: </span><span class="s1">'Comments'</span><span class="p">,</span> <span class="ss">total: </span><span class="n">comments_count</span><span class="p">)</span>
    <span class="n">comments</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">comment</span><span class="o">|</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">invoke</span><span class="p">(</span><span class="n">comment</span><span class="p">.</span><span class="nf">body</span><span class="p">)</span>
 
      <span class="n">comment</span><span class="p">.</span><span class="nf">predicted_appropriate</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">'index'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
      <span class="n">comment</span><span class="p">.</span><span class="nf">predicted_appropriate_confidence</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">'confidence'</span><span class="p">]</span>
      <span class="n">comment</span><span class="p">.</span><span class="nf">predicted_appropriate_updated_at</span> <span class="o">=</span> <span class="no">DateTime</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span>
      <span class="n">comment</span><span class="p">.</span><span class="nf">save!</span>
 
      <span class="n">progressbar</span><span class="p">.</span><span class="nf">increment</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Running the command:</p>

<pre><code class="language-rake">rake ml:predict_comments
</code></pre>

<p>Once that completes all of the comments have a prediction for whether that comment is appropriate or not, along with a confidence level provided by the model.</p>

<h2 id="step-4-filter-the-comments">Step 4: Filter the Comments</h2>

<p>After recording all the predicted values and their confidences, all that‚Äôs left is to filter out comments that were either manually marked as inappropriate, or were marked as inappropriate with high confidence by Nyckel.</p>

<h2 id="next-steps">Next Steps</h2>

<p>So now the model has looked over all of the comments already in the database, but everything we‚Äôve done so far has required running rake commands on the command line. New comments coming in won‚Äôt automatically be predicted. And, if we hand-annotate additional comments in our admin UI, they won‚Äôt automatically be sent to Nyckel to be incorporated into the model.</p>

<p>Ideally, when a new comment comes in or a new hand-annotation is made, we‚Äôd kick off an async task to call the appropriate Nyckel API. We‚Äôve previously used the DelayedJob gem for this type of thing, and will probably use it again here.</p>

<h2 id="wrap-up">Wrap Up</h2>

<p>It‚Äôs a huge piece of mind having a more reasonable process for moderating the comments. And as we upload new comments and annotations to Nyckel the model improves, and so does our ML comment moderation. Browsing through the results it‚Äôs pretty remarkable how well it does even with a few hundred annotated comments.</p>

<p>Clearly machine learning is a powerful tool, but it‚Äôs a complicated subject area, and one that neither of us were looking to become experts in. For whatsthatcharge.com, Nyckel closed that gap for us and saved some nights and weekends of manual moderation.</p>
:ET